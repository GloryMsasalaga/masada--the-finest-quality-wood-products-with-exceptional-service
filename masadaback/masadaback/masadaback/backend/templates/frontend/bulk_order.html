{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}Bulk Order - Masada{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-effect p-4 rounded-4 shadow-sm">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="display-6 mb-1">Bulk Purchase Portal</h1>
                        <p class="text-muted mb-0">Professional order management for contractors and retailers.</p>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-primary px-3 py-2 rounded-pill">
                            <i class="fas fa-percent me-2"></i>{{ discount_tier }} Discount Applied
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Search and Filter -->
        <div class="col-12 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text bg-transparent border-end-0">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" id="bulkSearch" class="form-control border-start-0"
                                    placeholder="Search by product name or ID...">
                            </div>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary active"
                                    onclick="filterCategory('all')">All</button>
                                {% for category in categories %}
                                <button type="button" class="btn btn-outline-secondary"
                                    onclick="filterCategory('{{ category }}')">{{ category }}</button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Table -->
        <div class="col-12">
            <div class="card border-0 shadow-lg overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="bulkTable">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Product Info</th>
                                <th>Category</th>
                                <th>Unit Price</th>
                                <th>Quantity</th>
                                <th>Subtotal</th>
                                <th class="pe-4 text-end">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products %}
                            <tr class="product-row" data-category="{{ product.Category }}">
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="product-icon me-3 bg-secondary bg-opacity-10 p-2 rounded">
                                            <i class="fas fa-box text-primary"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0 fw-bold">{{ product.ProductName }}</h6>
                                            <small class="text-muted">ID: {{ product.product_id|slice:":8" }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="badge bg-light text-dark fw-normal border">{{ product.Category
                                        }}</span></td>
                                <td class="price-cell" data-price="{{ product.Price_per_unit }}">${{
                                    product.Price_per_unit }}</td>
                                <td style="width: 150px;">
                                    <div class="input-group input-group-sm">
                                        <button class="btn btn-outline-secondary" type="button"
                                            onclick="changeQty('{{ product.product_id }}', -1)">-</button>
                                        <input type="number" class="form-control text-center qty-input"
                                            id="qty-{{ product.product_id }}" value="0" min="0"
                                            onchange="updateRow('{{ product.product_id }}')">
                                        <button class="btn btn-outline-secondary" type="button"
                                            onclick="changeQty('{{ product.product_id }}', 1)">+</button>
                                    </div>
                                </td>
                                <td class="subtotal-cell fw-bold text-primary" id="subtotal-{{ product.product_id }}">
                                    $0.00</td>
                                <td class="pe-4 text-end">
                                    <button class="btn btn-sm btn-primary rounded-pill px-3"
                                        onclick="addToCartBulk('{{ product.product_id }}')">
                                        <i class="fas fa-cart-plus me-1"></i>Add
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Summary Bar -->
    <div class="bulk-footer bg-dark text-white p-3 shadow-lg fixed-bottom" id="summaryBar" style="display: none;">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <span class="me-4"><i class="fas fa-shopping-cart me-2"></i>Items Selected: <span id="totalItems"
                        class="fw-bold">0</span></span>
                <span><i class="fas fa-wallet me-2"></i>Total Estimate: <span id="totalEstimate"
                        class="fw-bold">$0.00</span></span>
            </div>
            <div>
                <button class="btn btn-outline-light me-2" onclick="resetAll()">Clear All</button>
                <button class="btn btn-primary px-4" onclick="addAllToCart()">
                    Add Selection to Cart <i class="fas fa-arrow-right ms-2"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .product-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .bulk-footer {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
    }

    .qty-input::-webkit-inner-spin-button,
    .qty-input::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    #bulkTable tbody tr {
        transition: all 0.2s ease;
    }

    #bulkTable tbody tr:hover {
        background-color: rgba(210, 105, 30, 0.03);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    function changeQty(id, delta) {
        const input = document.getElementById('qty-' + id);
        let val = parseInt(input.value) + delta;
        if (val < 0) val = 0;
        input.value = val;
        updateRow(id);
    }

    function updateRow(id) {
        const input = document.getElementById('qty-' + id);
        const price = parseFloat(document.querySelector(`#qty-${id}`).closest('tr').querySelector('.price-cell').dataset.price);
        const subtotal = (parseInt(input.value) || 0) * price;
        document.getElementById('subtotal-' + id).textContent = '$' + subtotal.toFixed(2);
        updateSummary();
    }

    function updateSummary() {
        let totalItems = 0;
        let totalValue = 0;

        document.querySelectorAll('.qty-input').forEach(input => {
            const qty = parseInt(input.value) || 0;
            if (qty > 0) {
                totalItems += qty;
                const price = parseFloat(input.closest('tr').querySelector('.price-cell').dataset.price);
                totalValue += qty * price;
            }
        });

        document.getElementById('totalItems').textContent = totalItems;
        document.getElementById('totalEstimate').textContent = '$' + totalValue.toFixed(2);
        document.getElementById('summaryBar').style.display = totalItems > 0 ? 'block' : 'none';
    }

    function filterCategory(cat) {
        document.querySelectorAll('.product-row').forEach(row => {
            if (cat === 'all' || row.dataset.category === cat) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        // Update active button state
        event.target.parentElement.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    // Search functionality
    document.getElementById('bulkSearch').addEventListener('input', function (e) {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('.product-row').forEach(row => {
            const name = row.querySelector('h6').textContent.toLowerCase();
            const id = row.querySelector('small').textContent.toLowerCase();
            if (name.includes(term) || id.includes(term)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    function addToCartBulk(id) {
        const qty = parseInt(document.getElementById('qty-' + id).value);
        if (qty <= 0) {
            showAlert('warning', 'Please enter a quantity greater than zero.');
            return;
        }
        addToCart(id, qty);
    }

    function addAllToCart() {
        const items = [];
        document.querySelectorAll('.qty-input').forEach(input => {
            const qty = parseInt(input.value) || 0;
            if (qty > 0) {
                const id = input.id.replace('qty-', '');
                items.push({ id, qty });
            }
        });

        if (items.length === 0) return;

        // Process sequentially or via a new batch API
        // For simplicity, we'll loop the existing addToCart
        Promise.all(items.map(item => {
            return fetch('/add-to-cart/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    product_id: item.id,
                    quantity: item.qty
                })
            }).then(r => r.json());
        })).then(results => {
            const success = results.every(r => r.success);
            if (success) {
                showAlert('success', `Added ${items.length} product types to your cart.`);
                resetAll();
                updateCartCount();
            } else {
                showAlert('danger', 'Some items could not be added. Please check stock levels.');
            }
        });
    }

    function resetAll() {
        document.querySelectorAll('.qty-input').forEach(input => {
            input.value = 0;
            const subtotalId = 'subtotal-' + input.id.replace('qty-', '');
            document.getElementById(subtotalId).textContent = '$0.00';
        });
        updateSummary();
    }
</script>
{% endblock %}